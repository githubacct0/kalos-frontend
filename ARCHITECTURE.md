# Kalos Architecture

This document exists to clarify the relationship between Kalos Frontend and [Kalos Core](https://github.com/rmilejcz/kalos-core) as well as how the entire setup works.

## Kalos Frontend Architecture

Kalos Frontend is split into quite a few folders:

- .cache and dist are created upon building the dev server
- .nyc_output and coverage are code coverage data generated by Mocha
- .vscode is for extension recommendations when you open the repo
- modules are the main modules that the website is broken up into
- node_modules and styles are self-explanatory
- templates is for the `yarn make` command. NewComponent are the files included when a new component is created, and NewModule is the same but for new modules instead
- test is where our frontend unit tests live

## The Components Library

Our modules are made up of multiple components. You can mostly think of modules as individual pages and components as pieces of each module (you are probably already familiar with this concept).

Components are entirely encapsulated within the components library. This is located in `/modules/ComponentsLibrary`. Inside of this:

- The `index.tsx`, `index.html` and other files inside of the main `ComponentsLibrary` folder are for running the components as a module (`yarn start --ComponentsLibrary`)
- Each folder is a component
- Each component folder has an `examples.tsx` file which contains examples to be shown when the ComponentsLibrary is run as a module
  - You should add these examples manually via importing them in `index.tsx` (in alphabetical order please)

## About our frontend unit testing setup

Inside the test folder, we have a mockup of the repository's file structure with tests inside of them based upon the thing being tested.

We use `ts-mocha` in NodeJS to run our tests. It adds our node_modules into the testing environment (since we integrate our client release into the node_modules folder, it allows for easy stubbing and integration testing if we desire to do so in the future) then runs all of our unit tests. Since it is run inside of Node, we have the testing setup squared away inside the test-setup folder, where setup of our testing dependencies is stored.

You can read more about testing in /test/readme.md.

## Relationship to Kalos Core

### Overview

Kalos Frontend has Kalos Core as a dependency which is upgraded periodically when new releases are made. New versions can be grabbed using `yarn upgrade-interactive` and this is encouraged to prevent parity errors when someone pushes a new feature.

When a push is made in Kalos Core, it is pushed to [Circle CI](https://app.circleci.com/pipelines/github/rmilejcz) to undergo integration testing and to build. Once that build is done, the development server will have been pushed during the `deploy_to_dev` step and will be ready for any calls made during release that use new features.

### About the actual server

The development server is hosted as an ECS Cluster on [AWS](https://us-west-2.console.aws.amazon.com/ecs/home?region=us-west-2#/clusters/kalos-apps/services).

### About the development database

The "old" development database is a MySQL database hosted in [RDS on AWS](https://us-west-2.console.aws.amazon.com/rds/home?region=us-west-2#database:id=kalos-dev;is-cluster=false).

It is still in-use at the time of writing, but it may be deprecated soon in favor of [this one](https://console.aws.amazon.com/rds/home?region=us-east-1#database:id=kalos-dev-auto-prod-backup-open;is-cluster=false) which has a few advantages over the "old" database:

- It is hosted in us-east-1 instead of us-west-2, which is closer to where Kalos actually operates
- It is periodically overwritten by a DMS task (the dev data is replaced with fresh production data)

### About the new development database DMS task and setup

The [new database](https://console.aws.amazon.com/rds/home?region=us-east-1#database:id=kalos-dev-auto-prod-backup-open;is-cluster=false) is regularly overwritten by [this DMS task](https://console.aws.amazon.com/dms/v2/home?region=us-east-1#taskDetails/kalos-prod-to-dev-task-open). The task is set to run by a crontab job on [this EC2 instance](https://console.aws.amazon.com/ec2/v2/home?region=us-east-1#InstanceDetails:instanceId=i-0e8555f3af17025c7). The job simply starts the DMS replication task periodically and all of the data from our [production database](https://console.aws.amazon.com/rds/home?region=us-east-1#database:id=kalosnewprod;is-cluster=false) gets backed up into it. This will allow us to work with fresh data from our actual technicians. You can also trigger the DMS task manually if there is an issue being reported on a specific event / piece of data (once this is all hooked up, of course).

#### How do I change the time the task runs or the DMS task?

You can ssh into [this EC2 instance](https://console.aws.amazon.com/ec2/v2/home?region=us-east-1#InstanceDetails:instanceId=i-0e8555f3af17025c7) and then use `crontab -e` to view the task being run (or set a new time). Inside the file being run by crontab should be the command to start the DMS task, where you can change the ARN for the task if you need to.

### Small Issues

It is possible to upgrade Kalos Core in Kalos Frontend before the dev server is actually ready to handle it. This usually results in "Unknown function" errors. To resolve this, simply wait until the deployment is finished.

## Oh no! Prod is down! What do I do?

Stay calm, identify the source of the issue that caused prod to go down in the first place if possible, and reboot [this RDS instance once you've figured it out](https://console.aws.amazon.com/rds/home?region=us-east-1#database:id=kalosnewprod;is-cluster=false). Try to reboot the thing as quickly as possible though.

## Oh no! Dev is down! What do I do?

This is much less of an issue than prod being down, but it still isn't exactly optimal. First, identify the source and then reboot [this RDS instance](https://us-west-2.console.aws.amazon.com/rds/home?region=us-west-2#database:id=kalos-dev;is-cluster=false) (or [this RDS instance](https://console.aws.amazon.com/rds/home?region=us-east-1#database:id=kalos-dev-auto-prod-backup-open;is-cluster=false) if we've already migrated to that one).
